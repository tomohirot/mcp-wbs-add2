{
  "id": "snapshot_1766895011484_h7elr74xz",
  "approvalId": "approval_1766895011479_57b5rsv9f",
  "approvalTitle": "Codebase structure and patterns document",
  "version": 1,
  "timestamp": "2025-12-28T04:10:11.484Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Project Structure\n\n## Directory Organization\n\n```\nmcp-wbs-add2/\n├── src/                        # メインソースコード\n│   ├── main.py                # Cloud Functions エントリーポイント\n│   ├── mcp/                   # MCPサーバー実装\n│   │   ├── __init__.py\n│   │   ├── server.py          # MCPサーバー本体\n│   │   ├── handlers.py        # リクエストハンドラー\n│   │   └── schemas.py         # MCPリクエスト/レスポンススキーマ\n│   ├── services/              # ビジネスロジック\n│   │   ├── __init__.py\n│   │   ├── wbs_service.py     # WBS新規作成サービス\n│   │   ├── master_service.py  # マスターデータ設定サービス\n│   │   ├── task_merger.py     # タスクマージロジック\n│   │   └── category_detector.py # カテゴリ判定ロジック\n│   ├── integrations/          # 外部サービス連携\n│   │   ├── __init__.py\n│   │   ├── backlog/\n│   │   │   ├── __init__.py\n│   │   │   ├── client.py      # Backlog MCPクライアント\n│   │   │   └── models.py      # Backlogデータモデル\n│   │   ├── notion/\n│   │   │   ├── __init__.py\n│   │   │   ├── client.py      # Notion MCPクライアント\n│   │   │   └── models.py      # Notionデータモデル\n│   │   └── mcp_factory.py     # MCPクライアントファクトリ\n│   ├── processors/            # データ処理\n│   │   ├── __init__.py\n│   │   ├── document_processor.py # Document AI統合\n│   │   ├── converter.py       # JSON/Markdown変換\n│   │   └── url_parser.py      # URL解析とサービス判定\n│   ├── storage/               # データ永続化\n│   │   ├── __init__.py\n│   │   ├── gcs_client.py      # GCSクライアント\n│   │   ├── firestore_client.py # Firestoreクライアント\n│   │   └── metadata.py        # メタデータモデル\n│   ├── utils/                 # ユーティリティ\n│   │   ├── __init__.py\n│   │   ├── logger.py          # Cloud Loggingラッパー\n│   │   ├── config.py          # 設定管理\n│   │   └── validators.py      # バリデーション\n│   └── models/                # データモデル\n│       ├── __init__.py\n│       ├── task.py            # タスクモデル\n│       ├── metadata.py        # メタデータモデル\n│       └── enums.py           # 列挙型定義\n├── tests/                     # テストコード\n│   ├── unit/                  # ユニットテスト\n│   │   ├── test_services/\n│   │   ├── test_processors/\n│   │   ├── test_integrations/\n│   │   └── test_storage/\n│   ├── integration/           # 統合テスト\n│   │   ├── test_backlog_integration.py\n│   │   ├── test_notion_integration.py\n│   │   └── test_gcp_integration.py\n│   └── fixtures/              # テストデータ\n│       ├── sample_wbs.json\n│       ├── sample_tasks.md\n│       └── mock_responses/\n├── config/                    # 設定ファイル\n│   ├── settings.yaml          # 環境別設定\n│   ├── categories.yaml        # カテゴリマスターデータ\n│   └── issue_types.yaml       # 種別マスターデータ\n├── scripts/                   # ユーティリティスクリプト\n│   ├── deploy.sh              # Cloud Functionsデプロイスクリプト\n│   ├── setup_mcp.py           # MCPサーバーセットアップ\n│   └── test_local.py          # ローカルテスト実行\n├── docs/                      # ドキュメント\n│   ├── api.md                 # API仕様\n│   ├── setup.md               # セットアップガイド\n│   └── architecture.md        # アーキテクチャ設計\n├── .spec-workflow/            # Spec Workflow管理\n│   ├── templates/\n│   ├── steering/\n│   └── specs/\n├── requirements.txt           # Python依存パッケージ\n├── requirements-dev.txt       # 開発用依存パッケージ\n├── pytest.ini                 # pytest設定\n├── .env.example               # 環境変数サンプル\n├── .gcloudignore              # Cloud Functionsデプロイ除外設定\n└── README.md                  # プロジェクト概要\n```\n\n## Naming Conventions\n\n### Files\n- **モジュール**: `snake_case`（例: `wbs_service.py`, `task_merger.py`）\n- **テストファイル**: `test_[module_name].py`（例: `test_wbs_service.py`）\n- **設定ファイル**: `lowercase.yaml` または `lowercase.json`\n- **スクリプト**: `snake_case.sh` または `snake_case.py`\n\n### Code\n- **クラス**: `PascalCase`（例: `WBSService`, `BacklogClient`, `TaskModel`）\n- **関数/メソッド**: `snake_case`（例: `create_wbs()`, `merge_tasks()`, `detect_category()`）\n- **定数**: `UPPER_SNAKE_CASE`（例: `MAX_RETRY_COUNT`, `DEFAULT_CATEGORY`）\n- **変数**: `snake_case`（例: `task_list`, `file_url`, `metadata_dict`）\n- **プライベートメソッド**: `_leading_underscore`（例: `_validate_input()`, `_parse_response()`）\n\n### ディレクトリ\n- すべて`lowercase`または`snake_case`（例: `services`, `integrations`, `test_fixtures`）\n\n## Import Patterns\n\n### Import Order\n1. **標準ライブラリ**: Python標準ライブラリ\n2. **サードパーティライブラリ**: pip でインストールしたパッケージ\n3. **Google Cloudライブラリ**: google-cloud-* パッケージ\n4. **ローカルモジュール**: 絶対インポート（`from src.services import ...`）\n5. **相対インポート**: 同一パッケージ内（`from . import ...`, `from .. import ...`）\n\n### Import 例\n```python\n# 1. 標準ライブラリ\nimport os\nimport json\nfrom typing import List, Dict, Optional\nfrom datetime import datetime\n\n# 2. サードパーティライブラリ\nimport requests\nfrom pydantic import BaseModel, Field\n\n# 3. Google Cloudライブラリ\nfrom google.cloud import storage, firestore, documentai\nfrom google.cloud import logging as cloud_logging\n\n# 4. ローカルモジュール（絶対インポート）\nfrom src.models.task import Task, TaskCategory\nfrom src.utils.logger import get_logger\nfrom src.integrations.backlog.client import BacklogClient\n\n# 5. 相対インポート（同一パッケージ内）\nfrom .schemas import MCPRequest, MCPResponse\nfrom ..utils.validators import validate_url\n```\n\n### Module Organization\n- **絶対インポート優先**: `from src.services.wbs_service import WBSService`\n- **相対インポートは同一パッケージ内のみ**: パッケージ内の結合度が高いモジュール間\n- **循環インポート回避**: 必要に応じて型ヒント用の`TYPE_CHECKING`を使用\n\n## Code Structure Patterns\n\n### Module/Class Organization\n各Pythonファイル内は以下の順序で構成：\n\n1. **Docstring**: モジュールの説明（Google Style）\n2. **Imports**: 上記のImport Order に従う\n3. **Constants**: モジュールレベルの定数\n4. **Type Definitions**: Pydanticモデル、TypedDict、Enum等\n5. **Main Classes**: メインの実装クラス\n6. **Helper Functions**: プライベートヘルパー関数（`_`始まり）\n7. **Public API**: エクスポートする関数（`__all__`定義）\n\n### ファイル例\n```python\n\"\"\"\nWBS作成サービス\n\nテンプレートと新規課題をマージしてBacklogに一括登録する機能を提供。\n\"\"\"\n\n# Imports...\n\n# Constants\nDEFAULT_CATEGORY = \"要件定義\"\nMAX_BATCH_SIZE = 100\n\n# Type Definitions\nclass TaskInput(BaseModel):\n    title: str\n    description: Optional[str] = None\n    category: str = DEFAULT_CATEGORY\n\n# Main Classes\nclass WBSService:\n    \"\"\"WBS作成を管理するサービスクラス\"\"\"\n\n    def __init__(self, backlog_client: BacklogClient):\n        self.client = backlog_client\n        self.logger = get_logger(__name__)\n\n    def create_wbs(self, template_url: str, new_tasks: List[TaskInput]) -> Dict:\n        \"\"\"WBSを新規作成\"\"\"\n        # Implementation...\n\n# Helper Functions\ndef _merge_task_lists(template_tasks: List[Task], new_tasks: List[Task]) -> List[Task]:\n    \"\"\"内部ヘルパー: タスクリストをマージ\"\"\"\n    # Implementation...\n\n# Public API\n__all__ = [\"WBSService\", \"TaskInput\"]\n```\n\n### Function/Method Organization\n関数・メソッド内の構造：\n\n1. **Docstring**: 関数の説明、引数、戻り値（Google Style）\n2. **Input Validation**: 入力パラメータのバリデーション\n3. **Core Logic**: メインの処理ロジック\n4. **Error Handling**: try-except によるエラーハンドリング\n5. **Logging**: 重要な処理ステップのログ記録\n6. **Return**: 明示的な戻り値\n\n## Code Organization Principles\n\n1. **Single Responsibility**: 各モジュール・クラスは単一の責務を持つ\n   - `wbs_service.py`: WBS作成に関するビジネスロジックのみ\n   - `backlog/client.py`: Backlog APIとの通信のみ\n\n2. **Modularity**: 再利用可能な小さなモジュールに分割\n   - `processors/`: データ処理ロジックを独立モジュール化\n   - `integrations/`: 外部サービス連携を独立モジュール化\n\n3. **Testability**: テストしやすい構造\n   - 依存性注入（DI）パターンの使用\n   - モックしやすいインターフェース設計\n   - `tests/`ディレクトリに対応するテスト構造\n\n4. **Consistency**: プロジェクト全体で統一されたパターン\n   - すべてのサービスクラスは`*Service`命名\n   - すべてのクライアントクラスは`*Client`命名\n   - すべてのモデルは`models/`に集約\n\n## Module Boundaries\n\n### Core vs Integrations\n- **Core** (`services/`, `processors/`, `models/`): ビジネスロジックとデータ処理\n- **Integrations** (`integrations/`): 外部サービス依存を隔離\n- **依存方向**: Core → Integrations（逆方向の依存は禁止）\n\n### Public API vs Internal\n- **Public API**: `src/main.py` （Cloud Functionsエントリーポイント）\n- **Internal Implementation**: 各種サービス、プロセッサー、クライアント\n- **エクスポート**: `__all__`で公開APIを明示\n\n### Stable vs Experimental\n- **Stable**: `src/services/`, `src/integrations/`（本番コード）\n- **Experimental**: `scripts/`（実験的スクリプト）\n- **分離**: 実験的コードは本番コードに影響を与えない\n\n### Dependencies Direction\n```\nmain.py\n  ↓\nservices/ ← mcp/\n  ↓\nprocessors/ ← integrations/\n  ↓\nstorage/ ← models/ ← utils/\n```\n\n依存方向のルール：\n- 上位層は下位層に依存可能\n- 下位層は上位層に依存不可\n- 同一層内の依存は最小限に\n\n## Code Size Guidelines\n\n- **ファイルサイズ**: 1ファイル500行以内を目安（最大1000行）\n- **関数/メソッドサイズ**: 1関数50行以内を目安（最大100行）\n- **クラス複雑性**: 1クラス10メソッド以内を目安\n- **ネスト深度**: 最大4レベルまで（それ以上は関数分割）\n- **引数の数**: 1関数5引数以内（それ以上はデータクラス使用）\n\n### リファクタリング基準\n- 500行超えたらファイル分割を検討\n- 50行超えたら関数分割を検討\n- ネスト3レベル超えたら早期リターンやヘルパー関数を検討\n\n## MCP Server Structure\n\n### MCPサーバーの責務分離\n```\nsrc/mcp/\n├── server.py          # MCPサーバー本体（リクエスト受信、ルーティング）\n├── handlers.py        # ハンドラー（サービス層への委譲）\n└── schemas.py         # リクエスト/レスポンススキーマ\n```\n\n### 分離原則\n- **MCPサーバー**: プロトコル処理とリクエスト/レスポンス変換のみ\n- **サービス層**: ビジネスロジック実装\n- **統合層**: 外部MCP（Backlog、Notion）との通信\n\n### エントリーポイント\n```python\n# src/main.py\nfrom src.mcp.server import create_mcp_server\n\ndef main(request):\n    \"\"\"Cloud Functions エントリーポイント\"\"\"\n    server = create_mcp_server()\n    return server.handle_request(request)\n```\n\n## Documentation Standards\n\n### Docstring規約\n- **スタイル**: Google Style Docstrings\n- **必須対象**: すべての公開関数、クラス、メソッド\n- **推奨対象**: 複雑なプライベート関数\n\n### Docstring例\n```python\ndef merge_tasks(template_tasks: List[Task], new_tasks: List[Task]) -> List[Task]:\n    \"\"\"テンプレートタスクと新規タスクをマージする。\n\n    新規タスクのカテゴリを判定し、テンプレートタスクの適切な位置に\n    挿入して統合されたタスクリストを生成する。\n\n    Args:\n        template_tasks: テンプレートから取得したタスクのリスト\n        new_tasks: 新規に追加するタスクのリスト\n\n    Returns:\n        マージされたタスクのリスト（カテゴリ順にソート）\n\n    Raises:\n        ValueError: タスクが空リストの場合\n        CategoryNotFoundError: カテゴリ判定に失敗した場合\n    \"\"\"\n    # Implementation...\n```\n\n### コメント規約\n- **複雑なロジック**: アルゴリズムの説明を記載\n- **ビジネスルール**: なぜそのように実装したか理由を記載\n- **TODO/FIXME**: 将来の改善点を明示\n\n### READMEファイル\n- **プロジェクトルート**: `README.md`（概要、セットアップ、使い方）\n- **主要モジュール**: 各ディレクトリに`README.md`（責務と設計）\n\n## Testing Structure\n\n### テスト構成\n- **Unit Tests** (`tests/unit/`): 各モジュールの単体テスト\n- **Integration Tests** (`tests/integration/`): 外部サービス連携テスト\n- **Fixtures** (`tests/fixtures/`): テストデータとモック\n\n### テストファイル命名\n- `tests/unit/test_[module_path]/test_[module_name].py`\n- 例: `tests/unit/test_services/test_wbs_service.py`\n\n### テストカバレッジ目標\n- **全体**: 80%以上\n- **ビジネスロジック**: 90%以上\n- **統合層**: 70%以上（モックを活用）\n\n## Environment Configuration\n\n### 環境変数管理\n- **開発環境**: `.env`ファイル（gitignore対象）\n- **本番環境**: Google Secret Manager\n- **設定例**: `.env.example`をリポジトリに含める\n\n### 設定ファイル階層\n1. デフォルト設定: `config/settings.yaml`\n2. 環境変数オーバーライド: `.env`\n3. Cloud Functions環境変数: デプロイ時設定\n\n## Logging Strategy\n\n### ログレベル\n- **DEBUG**: 開発時の詳細情報\n- **INFO**: 通常の処理フロー（タスク登録成功など）\n- **WARNING**: 警告（リトライ発生など）\n- **ERROR**: エラー（API呼び出し失敗など）\n- **CRITICAL**: 致命的エラー（サービス停止レベル）\n\n### ログ出力先\n- **開発環境**: 標準出力\n- **本番環境**: Google Cloud Logging\n\n### ログ形式\n- **構造化ログ**: JSON形式でメタデータ付与\n- **トレース**: リクエストIDによる処理追跡\n",
  "fileStats": {
    "size": 15489,
    "lines": 385,
    "lastModified": "2025-12-28T04:10:06.449Z"
  },
  "comments": []
}