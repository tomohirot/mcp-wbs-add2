{
  "id": "snapshot_1766895887798_dw6wwnjd2",
  "approvalId": "approval_1766895887788_peysaxsvm",
  "approvalTitle": "WBS creation design document",
  "version": 1,
  "timestamp": "2025-12-28T04:24:47.798Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nWBS作成機能は、MCPサーバーとして動作し、テンプレートURLと新規タスクを受け付けて、Backlogに一括登録する機能です。以下の主要コンポーネントで構成されます：\n\n1. **MCPリクエストハンドラー**: MCPプロトコルでのリクエスト受信とレスポンス返却\n2. **WBSサービス**: WBS作成プロセス全体のオーケストレーション\n3. **データ取得プロセッサー**: URL解析、外部サービス連携、Document AI変換\n4. **タスクマージエンジン**: テンプレートと新規タスクのインテリジェントなマージ\n5. **Backlog統合クライアント**: Backlog MCPを通じたタスク登録とマスターデータ管理\n6. **ストレージマネージャー**: Firestore/GCSへのメタデータとデータ保存\n\nこの設計は、Single Responsibility原則に従い、各コンポーネントを疎結合に保ち、テスト可能性と拡張性を確保します。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n- **言語とランタイム**: Python 3.11+、Google Cloud Functions Gen2\n- **MCPアーキテクチャ**: MCP SDKを使用したサーバー実装、Backlog/Notion MCPクライアント統合\n- **GCP統合**: Document AI、GCS、Firestore、Cloud Loggingの活用\n- **データバリデーション**: Pydanticモデルを使用した型安全なデータ処理\n- **依存性注入**: サービスクラスにクライアントを注入し、テスト可能性を確保\n- **エラーハンドリング**: try-exceptブロックとリトライ機構（指数バックオフ）\n- **ログ戦略**: 構造化ログ（JSON形式）、リクエストIDによるトレーサビリティ\n\n### Project Structure (structure.md)\n\n以下のディレクトリ構造に従って実装します：\n\n```\nsrc/\n├── main.py                          # Cloud Functions エントリーポイント\n├── mcp/\n│   ├── server.py                    # MCPサーバー本体\n│   ├── handlers.py                  # create_wbs ハンドラー\n│   └── schemas.py                   # CreateWBSRequest/Response スキーマ\n├── services/\n│   ├── wbs_service.py               # WBS作成オーケストレーション\n│   ├── master_service.py            # マスターデータ設定\n│   ├── task_merger.py               # タスクマージロジック\n│   └── category_detector.py         # カテゴリ自動判定\n├── integrations/\n│   ├── backlog/\n│   │   ├── client.py                # Backlog MCPクライアント\n│   │   └── models.py                # Backlogデータモデル\n│   ├── notion/\n│   │   ├── client.py                # Notion MCPクライアント\n│   │   └── models.py                # Notionデータモデル\n│   └── mcp_factory.py               # MCPクライアントファクトリ\n├── processors/\n│   ├── document_processor.py        # Document AI統合\n│   ├── converter.py                 # JSON/Markdown変換\n│   └── url_parser.py                # URL解析とサービス判定\n├── storage/\n│   ├── gcs_client.py                # GCSクライアント\n│   ├── firestore_client.py          # Firestoreクライアント\n│   └── metadata.py                  # メタデータモデル\n├── models/\n│   ├── task.py                      # Task、TaskCategory モデル\n│   ├── metadata.py                  # FileMetadata モデル\n│   └── enums.py                     # CategoryEnum、IssueTypeEnum\n└── utils/\n    ├── logger.py                    # Cloud Loggingラッパー\n    ├── config.py                    # 設定管理\n    └── validators.py                # URLバリデーション\n```\n\n**命名規約**:\n- クラス: `PascalCase` (例: `WBSService`, `BacklogClient`)\n- 関数/メソッド: `snake_case` (例: `create_wbs()`, `merge_tasks()`)\n- 定数: `UPPER_SNAKE_CASE` (例: `DEFAULT_CATEGORY`)\n- Pydanticモデル: `PascalCase` (例: `CreateWBSRequest`)\n\n## Code Reuse Analysis\n\nこのプロジェクトは新規実装のため、既存コードはありませんが、以下の再利用可能なコンポーネントを設計します：\n\n### Existing Components to Leverage (将来的な再利用)\n\n- **URLParser**: 外部サービス判定ロジックは、将来の課題追加機能でも再利用可能\n- **DocumentProcessor**: Document AI統合は、他のファイル処理機能でも共通利用\n- **FirestoreClient/GCSClient**: ストレージクライアントは、全機能で共通利用\n- **Logger**: 構造化ログラッパーは、全機能で共通利用\n- **CategoryDetector**: カテゴリ判定ロジックは、課題追加機能でも利用可能\n\n### Integration Points\n\n- **MCP Server Protocol**: Backlog/Notion MCPサーバーとの統合\n- **Google Cloud Services**:\n  - Document AI: ファイル解析API\n  - Firestore: メタデータストレージ\n  - GCS: データファイルストレージ\n  - Cloud Logging: ログ記録\n- **Backlog API** (MCP経由):\n  - タスク取得、登録\n  - マスターデータ管理（種別、カテゴリ、カスタム属性）\n- **Notion API** (MCP経由):\n  - ページ取得\n  - データベースクエリ\n\n## Architecture\n\n### アーキテクチャ概要\n\nWBS作成機能は、以下の層で構成されるレイヤードアーキテクチャを採用します：\n\n1. **プロトコル層** (MCP Handler): リクエスト受信とバリデーション\n2. **サービス層** (WBS Service): ビジネスロジックのオーケストレーション\n3. **プロセッサー層** (Processors): データ変換とドメインロジック\n4. **統合層** (Integrations): 外部サービスとの通信\n5. **ストレージ層** (Storage): データ永続化\n\n### Modular Design Principles\n\n- **Single File Responsibility**: 各ファイルは単一の責務を持つ\n  - `wbs_service.py`: WBS作成プロセスのオーケストレーションのみ\n  - `task_merger.py`: タスクマージロジックのみ\n  - `category_detector.py`: カテゴリ判定ロジックのみ\n- **Component Isolation**: 小さく焦点を絞ったコンポーネント\n  - 各サービスクラスは500行以内\n  - 各メソッドは50行以内\n- **Service Layer Separation**: 層の責務分離\n  - MCPハンドラー: リクエスト/レスポンス変換のみ\n  - サービス層: ビジネスロジックのみ\n  - ストレージ層: データアクセスのみ\n- **Utility Modularity**: 単一目的のユーティリティ\n  - `url_parser.py`: URL解析とサービス判定のみ\n  - `validators.py`: バリデーションロジックのみ\n\n### アーキテクチャ図\n\n```mermaid\ngraph TD\n    Client[MCP Client] -->|MCP Request| MCPHandler[MCP Handler<br/>handlers.py]\n    MCPHandler -->|CreateWBSRequest| WBSService[WBS Service<br/>wbs_service.py]\n\n    WBSService -->|Setup Master Data| MasterService[Master Service<br/>master_service.py]\n    WBSService -->|Parse URL| URLParser[URL Parser<br/>url_parser.py]\n    WBSService -->|Fetch Template| MCPFactory[MCP Factory<br/>mcp_factory.py]\n    WBSService -->|Merge Tasks| TaskMerger[Task Merger<br/>task_merger.py]\n    WBSService -->|Register Tasks| BacklogClient[Backlog Client<br/>backlog/client.py]\n\n    URLParser -->|Service Type| MCPFactory\n    MCPFactory -->|Create Client| BacklogMCPClient[Backlog MCP Client]\n    MCPFactory -->|Create Client| NotionMCPClient[Notion MCP Client]\n\n    BacklogMCPClient -->|Fetch Data| DocumentProcessor[Document Processor<br/>document_processor.py]\n    NotionMCPClient -->|Fetch Data| DocumentProcessor\n\n    DocumentProcessor -->|Convert| Converter[Converter<br/>converter.py]\n    Converter -->|JSON/Markdown| StorageManager[Storage Manager]\n\n    TaskMerger -->|Detect Category| CategoryDetector[Category Detector<br/>category_detector.py]\n\n    MasterService -->|CRUD| BacklogClient\n    BacklogClient -->|Register| BacklogAPI[Backlog API<br/>via MCP]\n\n    StorageManager -->|Save Metadata| FirestoreClient[Firestore Client<br/>firestore_client.py]\n    StorageManager -->|Save Data| GCSClient[GCS Client<br/>gcs_client.py]\n\n    WBSService -->|Log| Logger[Logger<br/>logger.py]\n    Logger -->|Write| CloudLogging[Cloud Logging]\n\n    style MCPHandler fill:#e1f5fe\n    style WBSService fill:#fff9c4\n    style TaskMerger fill:#f0f4c3\n    style CategoryDetector fill:#f0f4c3\n    style BacklogClient fill:#ffe0b2\n    style StorageManager fill:#f8bbd0\n```\n\n### 処理フロー\n\n1. **リクエスト受信**: MCP Handlerが`create_wbs`リクエストを受信\n2. **マスターデータ設定**: Master Serviceが種別、カテゴリ、カスタム属性を設定\n3. **テンプレート取得**:\n   - URL Parserがサービスタイプを判定\n   - MCP Factoryが適切なクライアント（Backlog/Notion）を生成\n   - MCPクライアントが階層データを取得\n   - Document Processorがファイルを解析（必要に応じてDocument AI使用）\n   - ConverterがJSON/Markdownに変換\n   - Storage Managerがメタデータ（Firestore）とデータ（GCS）を保存\n4. **新規タスク解析**:\n   - Converterが新規タスクテキストをパース\n   - Category Detectorがカテゴリを自動判定\n5. **タスクマージ**:\n   - Task Mergerがテンプレートタスクと新規タスクをマージ\n   - カテゴリ順にソート\n6. **Backlog登録**:\n   - Backlog Clientが既存タスクを取得\n   - 重複チェック実施\n   - 未登録タスクのみを一括登録\n7. **結果返却**: MCP Handlerが登録結果をレスポンスとして返却\n\n## Components and Interfaces\n\n### Component 1: MCP Handler (handlers.py)\n\n- **Purpose**: MCPリクエストを受信し、WBSServiceに委譲し、レスポンスを返却\n- **Interfaces**:\n  ```python\n  async def handle_create_wbs(request: CreateWBSRequest) -> CreateWBSResponse:\n      \"\"\"WBS作成リクエストをハンドリング\"\"\"\n  ```\n- **Dependencies**: `WBSService`, `CreateWBSRequest`, `CreateWBSResponse`\n- **Reuses**: なし（新規実装）\n\n### Component 2: WBS Service (wbs_service.py)\n\n- **Purpose**: WBS作成プロセス全体のオーケストレーション\n- **Interfaces**:\n  ```python\n  class WBSService:\n      def __init__(\n          self,\n          master_service: MasterService,\n          url_parser: URLParser,\n          mcp_factory: MCPFactory,\n          task_merger: TaskMerger,\n          backlog_client: BacklogClient,\n          storage_manager: StorageManager,\n          logger: Logger\n      ):\n          \"\"\"依存性注入によるクライアント設定\"\"\"\n\n      async def create_wbs(\n          self,\n          template_url: str,\n          new_tasks_text: str,\n          project_key: str\n      ) -> WBSResult:\n          \"\"\"WBSを作成してBacklogに登録\"\"\"\n  ```\n- **Dependencies**: `MasterService`, `URLParser`, `MCPFactory`, `TaskMerger`, `BacklogClient`, `StorageManager`, `Logger`\n- **Reuses**: 各種サービスとクライアントを統合\n\n### Component 3: Master Service (master_service.py)\n\n- **Purpose**: Backlogプロジェクトのマスターデータを設定\n- **Interfaces**:\n  ```python\n  class MasterService:\n      def __init__(self, backlog_client: BacklogClient, logger: Logger):\n          \"\"\"依存性注入\"\"\"\n\n      async def setup_master_data(self, project_key: str) -> MasterDataResult:\n          \"\"\"種別、カテゴリ、カスタム属性を設定\"\"\"\n\n      async def _ensure_issue_types(self, project_key: str) -> List[str]:\n          \"\"\"種別（課題、リスク）を確認・追加\"\"\"\n\n      async def _ensure_categories(self, project_key: str) -> List[str]:\n          \"\"\"カテゴリを確認・追加\"\"\"\n\n      async def _ensure_custom_fields(self, project_key: str) -> List[str]:\n          \"\"\"カスタム属性（インプット、ゴール/アウトプット）を確認・追加\"\"\"\n  ```\n- **Dependencies**: `BacklogClient`, `Logger`\n- **Reuses**: `BacklogClient`を使用してマスターデータCRUD\n\n### Component 4: URL Parser (url_parser.py)\n\n- **Purpose**: URLを解析して外部サービスタイプを判定\n- **Interfaces**:\n  ```python\n  class URLParser:\n      def parse_service_type(self, url: str) -> ServiceType:\n          \"\"\"URLからサービスタイプ（Backlog/Notion）を判定\"\"\"\n\n      def validate_url(self, url: str) -> bool:\n          \"\"\"URL形式をバリデーション\"\"\"\n  ```\n- **Dependencies**: なし（純粋関数）\n- **Reuses**: なし（新規実装）\n\n### Component 5: MCP Factory (mcp_factory.py)\n\n- **Purpose**: サービスタイプに応じたMCPクライアントを生成\n- **Interfaces**:\n  ```python\n  class MCPFactory:\n      def create_client(self, service_type: ServiceType) -> Union[BacklogMCPClient, NotionMCPClient]:\n          \"\"\"サービスタイプに応じたMCPクライアントを生成\"\"\"\n  ```\n- **Dependencies**: `BacklogMCPClient`, `NotionMCPClient`\n- **Reuses**: なし（ファクトリパターン実装）\n\n### Component 6: Backlog MCP Client (integrations/backlog/client.py)\n\n- **Purpose**: Backlog MCPサーバーとの通信\n- **Interfaces**:\n  ```python\n  class BacklogMCPClient:\n      async def fetch_data(self, url: str) -> Dict[str, Any]:\n          \"\"\"BacklogからURLのデータを取得\"\"\"\n\n      async def get_tasks(self, project_key: str) -> List[BacklogTask]:\n          \"\"\"プロジェクトのタスク一覧を取得\"\"\"\n\n      async def create_tasks(self, project_key: str, tasks: List[Task]) -> List[BacklogTask]:\n          \"\"\"タスクを一括登録\"\"\"\n\n      async def get_issue_types(self, project_key: str) -> List[IssueType]:\n          \"\"\"種別一覧を取得\"\"\"\n\n      async def create_issue_type(self, project_key: str, name: str) -> IssueType:\n          \"\"\"種別を作成\"\"\"\n\n      async def get_categories(self, project_key: str) -> List[Category]:\n          \"\"\"カテゴリ一覧を取得\"\"\"\n\n      async def create_category(self, project_key: str, name: str) -> Category:\n          \"\"\"カテゴリを作成\"\"\"\n\n      async def get_custom_fields(self, project_key: str) -> List[CustomField]:\n          \"\"\"カスタム属性一覧を取得\"\"\"\n\n      async def create_custom_field(self, project_key: str, field: CustomFieldInput) -> CustomField:\n          \"\"\"カスタム属性を作成\"\"\"\n  ```\n- **Dependencies**: MCP SDK、Backlog MCP接続情報\n- **Reuses**: MCP SDKのクライアント機能\n\n### Component 7: Notion MCP Client (integrations/notion/client.py)\n\n- **Purpose**: Notion MCPサーバーとの通信\n- **Interfaces**:\n  ```python\n  class NotionMCPClient:\n      async def fetch_data(self, url: str) -> Dict[str, Any]:\n          \"\"\"NotionからURLのデータを取得\"\"\"\n  ```\n- **Dependencies**: MCP SDK、Notion MCP接続情報\n- **Reuses**: MCP SDKのクライアント機能\n\n### Component 8: Document Processor (processors/document_processor.py)\n\n- **Purpose**: Document AIを使用してファイルを解析\n- **Interfaces**:\n  ```python\n  class DocumentProcessor:\n      def __init__(self, documentai_client, logger: Logger):\n          \"\"\"Document AIクライアントを注入\"\"\"\n\n      async def process_file(self, file_content: bytes, mime_type: str) -> str:\n          \"\"\"ファイルをテキストに変換（Document AI使用）\"\"\"\n  ```\n- **Dependencies**: `google-cloud-documentai`, `Logger`\n- **Reuses**: Google Cloud Document AI API\n\n### Component 9: Converter (processors/converter.py)\n\n- **Purpose**: データをJSON/Markdownに変換\n- **Interfaces**:\n  ```python\n  class Converter:\n      def convert_to_json(self, data: Any) -> Dict[str, Any]:\n          \"\"\"データをJSON形式に変換\"\"\"\n\n      def convert_to_markdown(self, text: str) -> str:\n          \"\"\"テキストをMarkdown形式に変換\"\"\"\n\n      def parse_tasks_from_text(self, text: str) -> List[Task]:\n          \"\"\"テキストからタスクリストをパース\"\"\"\n  ```\n- **Dependencies**: なし（純粋関数）\n- **Reuses**: なし（新規実装）\n\n### Component 10: Task Merger (services/task_merger.py)\n\n- **Purpose**: テンプレートタスクと新規タスクをマージ\n- **Interfaces**:\n  ```python\n  class TaskMerger:\n      def __init__(self, category_detector: CategoryDetector, logger: Logger):\n          \"\"\"依存性注入\"\"\"\n\n      def merge_tasks(self, template_tasks: List[Task], new_tasks: List[Task]) -> List[Task]:\n          \"\"\"タスクリストをマージしてカテゴリ順にソート\"\"\"\n  ```\n- **Dependencies**: `CategoryDetector`, `Logger`\n- **Reuses**: `CategoryDetector`\n\n### Component 11: Category Detector (services/category_detector.py)\n\n- **Purpose**: タスク内容からカテゴリを自動判定\n- **Interfaces**:\n  ```python\n  class CategoryDetector:\n      def detect_category(self, task: Task) -> CategoryEnum:\n          \"\"\"タスクのタイトルと説明からカテゴリを判定\"\"\"\n\n      def _match_keywords(self, text: str, category: CategoryEnum) -> float:\n          \"\"\"テキストとカテゴリのキーワードマッチングスコア\"\"\"\n  ```\n- **Dependencies**: なし（ルールベース実装）\n- **Reuses**: なし（新規実装）\n\n### Component 12: Storage Manager (storage/)\n\n- **Purpose**: Firestore/GCSへのデータ保存\n- **Interfaces**:\n  ```python\n  class StorageManager:\n      def __init__(\n          self,\n          firestore_client: FirestoreClient,\n          gcs_client: GCSClient,\n          logger: Logger\n      ):\n          \"\"\"依存性注入\"\"\"\n\n      async def save_data(\n          self,\n          parent_url: str,\n          file_url: str,\n          file_name: str,\n          data: Union[Dict, str],\n          format: str\n      ) -> FileMetadata:\n          \"\"\"データとメタデータを保存（バージョン管理）\"\"\"\n\n      async def get_latest_version(self, file_url: str) -> Optional[FileMetadata]:\n          \"\"\"最新バージョンのメタデータを取得\"\"\"\n\n      async def get_data(self, metadata: FileMetadata) -> Union[Dict, str]:\n          \"\"\"メタデータを元にGCSからデータを取得\"\"\"\n  ```\n- **Dependencies**: `FirestoreClient`, `GCSClient`, `Logger`\n- **Reuses**: `FirestoreClient`, `GCSClient`\n\n### Component 13: Firestore Client (storage/firestore_client.py)\n\n- **Purpose**: Firestoreへのメタデータ保存・検索\n- **Interfaces**:\n  ```python\n  class FirestoreClient:\n      async def save_metadata(self, metadata: FileMetadata) -> str:\n          \"\"\"メタデータをFirestoreに保存\"\"\"\n\n      async def get_latest_metadata(self, file_url: str) -> Optional[FileMetadata]:\n          \"\"\"最新バージョンのメタデータを取得\"\"\"\n\n      async def get_metadata_by_version(self, file_url: str, version: int) -> Optional[FileMetadata]:\n          \"\"\"特定バージョンのメタデータを取得\"\"\"\n  ```\n- **Dependencies**: `google-cloud-firestore`\n- **Reuses**: Google Cloud Firestore API\n\n### Component 14: GCS Client (storage/gcs_client.py)\n\n- **Purpose**: GCSへのデータ保存・取得\n- **Interfaces**:\n  ```python\n  class GCSClient:\n      async def upload_data(self, bucket: str, path: str, data: Union[Dict, str]) -> str:\n          \"\"\"データをGCSにアップロード\"\"\"\n\n      async def download_data(self, bucket: str, path: str) -> Union[Dict, str]:\n          \"\"\"GCSからデータをダウンロード\"\"\"\n  ```\n- **Dependencies**: `google-cloud-storage`\n- **Reuses**: Google Cloud Storage API\n\n### Component 15: Logger (utils/logger.py)\n\n- **Purpose**: 構造化ログをCloud Loggingに記録\n- **Interfaces**:\n  ```python\n  class Logger:\n      def __init__(self, request_id: str):\n          \"\"\"リクエストIDを設定してトレーサビリティ確保\"\"\"\n\n      def info(self, message: str, **kwargs):\n          \"\"\"INFOレベルログ\"\"\"\n\n      def error(self, message: str, error: Exception = None, **kwargs):\n          \"\"\"ERRORレベルログ\"\"\"\n\n      def debug(self, message: str, **kwargs):\n          \"\"\"DEBUGレベルログ\"\"\"\n  ```\n- **Dependencies**: `google-cloud-logging`\n- **Reuses**: Google Cloud Logging API\n\n## Data Models\n\n### CreateWBSRequest (mcp/schemas.py)\n\n```python\nfrom pydantic import BaseModel, HttpUrl\n\nclass CreateWBSRequest(BaseModel):\n    \"\"\"WBS作成リクエスト\"\"\"\n    template_url: HttpUrl  # テンプレートURL（Backlog or Notion）\n    new_tasks_text: str  # 新規タスクのテキスト（Markdown形式）\n    project_key: str  # Backlogプロジェクトキー\n```\n\n### CreateWBSResponse (mcp/schemas.py)\n\n```python\nfrom typing import List\nfrom pydantic import BaseModel\n\nclass TaskResult(BaseModel):\n    \"\"\"登録されたタスクの結果\"\"\"\n    id: str  # Backlogタスクキー\n    title: str  # タスクタイトル\n    url: str  # BacklogタスクURL\n    category: str  # カテゴリ\n\nclass CreateWBSResponse(BaseModel):\n    \"\"\"WBS作成レスポンス\"\"\"\n    success: bool  # 成功/失敗\n    registered_tasks: List[TaskResult]  # 登録成功タスク\n    skipped_tasks: List[str]  # スキップされたタスクのタイトル\n    error_message: Optional[str] = None  # エラーメッセージ\n    metadata_id: Optional[str] = None  # FirestoreメタデータドキュメントID\n```\n\n### Task (models/task.py)\n\n```python\nfrom pydantic import BaseModel\nfrom typing import Optional\nfrom .enums import CategoryEnum\n\nclass Task(BaseModel):\n    \"\"\"タスクモデル\"\"\"\n    title: str  # タスクタイトル\n    description: Optional[str] = None  # タスク説明\n    category: CategoryEnum  # カテゴリ\n    priority: Optional[str] = None  # 優先度（高、中、低）\n    assignee: Optional[str] = None  # 担当者\n    input: Optional[str] = None  # インプット（カスタム属性）\n    goal_output: Optional[str] = None  # ゴール/アウトプット（カスタム属性）\n```\n\n### FileMetadata (models/metadata.py)\n\n```python\nfrom pydantic import BaseModel, HttpUrl\nfrom datetime import datetime\n\nclass FileMetadata(BaseModel):\n    \"\"\"ファイルメタデータ\"\"\"\n    id: Optional[str] = None  # FirestoreドキュメントID\n    source_file_name: str  # 取得元ファイル名\n    parent_url: HttpUrl  # 親URL\n    file_url: HttpUrl  # ファイルURL\n    file_name: str  # ファイル名\n    updated_at: datetime  # 更新日\n    version: int  # バージョン番号\n    format: str  # フォーマット（json or markdown）\n    gcs_path: str  # GCS保存パス\n```\n\n### CategoryEnum (models/enums.py)\n\n```python\nfrom enum import Enum\n\nclass CategoryEnum(str, Enum):\n    \"\"\"カテゴリ列挙型\"\"\"\n    PREPARATION = \"事前準備\"\n    REQUIREMENTS = \"要件定義\"\n    BASIC_DESIGN = \"基本設計\"\n    IMPLEMENTATION = \"実装\"\n    TESTING = \"テスト\"\n    RELEASE = \"リリース\"\n    DELIVERY = \"納品\"\n```\n\n### IssueTypeEnum (models/enums.py)\n\n```python\nclass IssueTypeEnum(str, Enum):\n    \"\"\"種別列挙型\"\"\"\n    TASK = \"課題\"\n    RISK = \"リスク\"\n```\n\n### ServiceType (processors/url_parser.py)\n\n```python\nclass ServiceType(str, Enum):\n    \"\"\"外部サービスタイプ\"\"\"\n    BACKLOG = \"backlog\"\n    NOTION = \"notion\"\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **無効なURL**\n   - **Handling**: URLParserでバリデーション失敗時に`ValueError`をスロー。WBSServiceでキャッチしてエラーレスポンス返却\n   - **User Impact**: `CreateWBSResponse`の`error_message`に「URLが無効です。BacklogまたはNotionのURLを指定してください」を設定\n\n2. **外部サービス接続エラー**\n   - **Handling**: MCP Clientでの通信失敗時に`ConnectionError`をスロー。3回までリトライ（指数バックオフ：1秒、2秒、4秒）\n   - **User Impact**: リトライ後も失敗した場合、「Backlog/Notionとの接続に失敗しました。しばらく待ってから再試行してください」\n\n3. **Document AI処理エラー**\n   - **Handling**: Document Processorでの解析失敗時に`ProcessingError`をスロー。エラーログを記録し、処理を中断\n   - **User Impact**: 「ファイルの解析に失敗しました。ファイル形式を確認してください」\n\n4. **Backlog API認証エラー**\n   - **Handling**: Backlog Clientでの401エラー時に`AuthenticationError`をスロー\n   - **User Impact**: 「Backlog APIの認証に失敗しました。APIキーを確認してください」\n\n5. **タスク重複エラー**\n   - **Handling**: 重複タスクは`skipped_tasks`リストに追加し、登録をスキップ（エラーではない）\n   - **User Impact**: `CreateWBSResponse`の`skipped_tasks`に重複タスクのタイトルをリスト表示\n\n6. **Firestore/GCS保存エラー**\n   - **Handling**: Storage Managerでの保存失敗時に`StorageError`をスロー。エラーログを記録し、処理を中断\n   - **User Impact**: 「データの保存に失敗しました。GCPの権限設定を確認してください」\n\n7. **カテゴリ判定失敗**\n   - **Handling**: Category Detectorで判定不能時は`DEFAULT_CATEGORY`（要件定義）を使用。警告ログを記録\n   - **User Impact**: ユーザーには影響なし（デフォルトカテゴリが使用される）\n\n8. **タイムアウトエラー**\n   - **Handling**: 各API呼び出しにタイムアウト設定（Backlog: 30秒、Document AI: 60秒、GCS/Firestore: 10秒）\n   - **User Impact**: 「処理がタイムアウトしました。データサイズが大きすぎる可能性があります」\n\n### エラーレスポンス例\n\n```python\n# 成功時\nCreateWBSResponse(\n    success=True,\n    registered_tasks=[\n        TaskResult(id=\"PROJ-123\", title=\"要件定義\", url=\"...\", category=\"要件定義\"),\n        TaskResult(id=\"PROJ-124\", title=\"基本設計\", url=\"...\", category=\"基本設計\")\n    ],\n    skipped_tasks=[\"既存タスク1\"],  # 重複スキップ\n    error_message=None,\n    metadata_id=\"abc123def456\"\n)\n\n# エラー時\nCreateWBSResponse(\n    success=False,\n    registered_tasks=[],\n    skipped_tasks=[],\n    error_message=\"Backlog APIの認証に失敗しました。APIキーを確認してください\",\n    metadata_id=None\n)\n```\n\n## Testing Strategy\n\n### Unit Testing\n\n**テストフレームワーク**: pytest\n\n**テスト対象**:\n- `URLParser.parse_service_type()`: URL解析ロジック\n- `CategoryDetector.detect_category()`: カテゴリ判定ロジック\n- `TaskMerger.merge_tasks()`: タスクマージロジック\n- `Converter.parse_tasks_from_text()`: テキストパースロジック\n- 各Pydanticモデルのバリデーション\n\n**テストケース例**:\n```python\n# tests/unit/test_processors/test_url_parser.py\ndef test_parse_backlog_url():\n    parser = URLParser()\n    service_type = parser.parse_service_type(\"https://example.backlog.com/...\")\n    assert service_type == ServiceType.BACKLOG\n\ndef test_parse_notion_url():\n    parser = URLParser()\n    service_type = parser.parse_service_type(\"https://www.notion.so/...\")\n    assert service_type == ServiceType.NOTION\n\ndef test_invalid_url():\n    parser = URLParser()\n    with pytest.raises(ValueError):\n        parser.parse_service_type(\"https://example.com/...\")\n```\n\n```python\n# tests/unit/test_services/test_category_detector.py\ndef test_detect_requirements_category():\n    detector = CategoryDetector()\n    task = Task(title=\"要件のヒアリング\", description=\"顧客要件を確認する\")\n    category = detector.detect_category(task)\n    assert category == CategoryEnum.REQUIREMENTS\n\ndef test_detect_implementation_category():\n    detector = CategoryDetector()\n    task = Task(title=\"APIの実装\", description=\"REST APIを開発する\")\n    category = detector.detect_category(task)\n    assert category == CategoryEnum.IMPLEMENTATION\n```\n\n### Integration Testing\n\n**テスト対象**:\n- Backlog MCP Client統合テスト（モックMCPサーバー使用）\n- Firestore/GCS統合テスト（エミュレータ使用）\n- WBSService統合テスト（モック外部サービス使用）\n\n**テストケース例**:\n```python\n# tests/integration/test_backlog_integration.py\n@pytest.mark.asyncio\nasync def test_create_tasks_integration():\n    # Backlog MCPモックサーバーを起動\n    mock_server = MockBacklogMCPServer()\n    client = BacklogMCPClient(mock_server.url)\n\n    tasks = [\n        Task(title=\"タスク1\", category=CategoryEnum.REQUIREMENTS),\n        Task(title=\"タスク2\", category=CategoryEnum.IMPLEMENTATION)\n    ]\n\n    result = await client.create_tasks(\"PROJ\", tasks)\n    assert len(result) == 2\n    assert result[0].title == \"タスク1\"\n```\n\n```python\n# tests/integration/test_gcp_integration.py\n@pytest.mark.asyncio\nasync def test_storage_manager_save_and_retrieve():\n    # Firestore/GCSエミュレータを使用\n    firestore_client = FirestoreClient(emulator=True)\n    gcs_client = GCSClient(emulator=True)\n    storage_manager = StorageManager(firestore_client, gcs_client, logger)\n\n    # データ保存\n    metadata = await storage_manager.save_data(\n        parent_url=\"https://example.backlog.com/...\",\n        file_url=\"https://example.backlog.com/.../file\",\n        file_name=\"template.xlsx\",\n        data={\"tasks\": [...]},\n        format=\"json\"\n    )\n\n    # データ取得\n    retrieved_data = await storage_manager.get_data(metadata)\n    assert retrieved_data == {\"tasks\": [...]}\n```\n\n### End-to-End Testing\n\n**テスト対象**:\n- WBS作成エンドツーエンドフロー（MCPリクエスト→Backlog登録→レスポンス）\n\n**テストシナリオ**:\n1. **正常系**: テンプレートURL + 新規タスク → Backlog登録成功\n2. **重複スキップ**: 既存タスクと重複するタスクをスキップ\n3. **エラーハンドリング**: 無効なURL → エラーレスポンス返却\n4. **マスターデータ設定**: 不足しているカテゴリを自動追加\n\n**テストケース例**:\n```python\n# tests/e2e/test_wbs_creation_flow.py\n@pytest.mark.asyncio\nasync def test_wbs_creation_end_to_end():\n    # テスト用Backlogプロジェクトとモックサーバーを準備\n    mock_backlog = MockBacklogServer()\n    mock_backlog.add_project(\"TEST\")\n\n    # MCPリクエスト作成\n    request = CreateWBSRequest(\n        template_url=\"https://example.backlog.com/template\",\n        new_tasks_text=\"- タスク1: 要件確認\\n- タスク2: 設計レビュー\",\n        project_key=\"TEST\"\n    )\n\n    # WBS作成実行\n    response = await handle_create_wbs(request)\n\n    # 検証\n    assert response.success == True\n    assert len(response.registered_tasks) == 2\n    assert response.registered_tasks[0].title == \"タスク1\"\n    assert response.registered_tasks[0].category == \"要件定義\"\n```\n\n### テストカバレッジ目標\n- **全体**: 80%以上\n- **ビジネスロジック** (services/): 90%以上\n- **データ処理** (processors/): 85%以上\n- **統合層** (integrations/): 70%以上（モック使用）\n- **ストレージ層** (storage/): 75%以上（エミュレータ使用）\n",
  "fileStats": {
    "size": 31058,
    "lines": 795,
    "lastModified": "2025-12-28T04:24:40.966Z"
  },
  "comments": []
}