# Implementation Log: Task 13

**Summary:** Implemented TaskMerger service to merge template and new tasks by category, with category-based grouping and ordering (事前準備→要件定義→...→納品)

**Timestamp:** 2025-12-28T05:29:54.345Z
**Log ID:** e678db4a-0be7-4d28-aa3c-e4e27d2f358d

---

## Statistics

- **Lines Added:** +215
- **Lines Removed:** -0
- **Files Changed:** 1
- **Net Change:** 215

## Files Modified
_No files modified_

## Files Created
- src/services/task_merger.py

---

## Artifacts

### Functions

#### merge_tasks
- **Purpose:** Merge template and new tasks by category: (1) auto-categorize new tasks, (2) group by category, (3) within each category append template then new, (4) sort by category order (事前準備→納品)
- **Location:** src/services/task_merger.py:54
- **Signature:** def merge_tasks(self, template_tasks: List[Task], new_tasks: List[Task]) -> List[Task]
- **Exported:** Yes

#### _categorize_new_tasks
- **Purpose:** Auto-detect categories for new tasks that don't have category set, using CategoryDetector service
- **Location:** src/services/task_merger.py:118
- **Signature:** def _categorize_new_tasks(self, new_tasks: List[Task]) -> List[Task]
- **Exported:** No

#### _group_tasks_by_category
- **Purpose:** Group task list into dictionary with CategoryEnum as keys and List[Task] as values
- **Location:** src/services/task_merger.py:149
- **Signature:** def _group_tasks_by_category(self, tasks: List[Task]) -> Dict[CategoryEnum, List[Task]]
- **Exported:** No

#### get_category_order_index
- **Purpose:** Get sort index for a category based on CATEGORY_ORDER constant
- **Location:** src/services/task_merger.py:169
- **Signature:** def get_category_order_index(self, category: CategoryEnum) -> int
- **Exported:** Yes

#### sort_tasks_by_category
- **Purpose:** Sort task list by category order using get_category_order_index as sort key
- **Location:** src/services/task_merger.py:179
- **Signature:** def sort_tasks_by_category(self, tasks: List[Task]) -> List[Task]
- **Exported:** Yes

### Classes

#### TaskMerger
- **Purpose:** Service for merging template and new tasks by category, maintaining template task order within each category and appending new tasks after template tasks
- **Location:** src/services/task_merger.py
- **Methods:** merge_tasks (main orchestration method: categorize new tasks, group by category, merge preserving order, sort by category sequence), _categorize_new_tasks (auto-detect categories for new tasks using CategoryDetector), _group_tasks_by_category (group tasks into dictionary keyed by CategoryEnum), get_category_order_index (get sort index for a category), sort_tasks_by_category (sort task list by category order)
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** TaskMerger uses CategoryDetector for auto-categorizing new tasks that don't have categories
- **Frontend Component:** TaskMerger
- **Backend Endpoint:** CategoryDetector.detect_category
- **Data Flow:** New tasks without category → _categorize_new_tasks → CategoryDetector.detect_category for each task → Update task.category → Return categorized tasks

#### Integration
- **Description:** WBSService orchestrates TaskMerger to combine template and new tasks before Backlog registration
- **Frontend Component:** WBSService (future)
- **Backend Endpoint:** TaskMerger.merge_tasks
- **Data Flow:** Template tasks from MCP fetch + New tasks from text parsing → TaskMerger.merge_tasks → Categorize new → Group by category → Merge (template first, new second) per category → Sort by category order → Return unified task list → Register to Backlog

